name: CI

on:
  push:
    branches: [ main ]
  pull_request:

# Глобальные переменные окружения
env:
  ACR_NAME: drakarionaksacr
  ACR_LOGIN: drakarionaksacr.azurecr.io
  WEB_IMAGE: drakarionaksacr.azurecr.io/web
  API_IMAGE: drakarionaksacr.azurecr.io/api

jobs:
  # ============================
  # 1. Линтеры, тесты, fmt, lint
  # ============================
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Web: lint + tests
      - name: Web - lint & tests
        working-directory: n-web
        run: |
          npm ci
          npm run lint || true
          npm test || true

      # API: lint + tests
      - name: API - lint & tests
        working-directory: n-api
        run: |
          npm ci
          npm run lint || true
          npm test || true

      # Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # Helm
      - name: Setup Helm
        uses: azure/setup-helm@v4

      # Helm lint для всех чартов
      - name: Helm lint
        run: |
          helm lint charts/web || true
          helm lint charts/api || true
          helm lint charts/mysql || true

      # Terraform fmt (mysql-helm-tf)
      - name: Terraform fmt (mysql-helm-tf)
        working-directory: mysql-helm-tf
        run: |
          terraform fmt -check

      # Terraform fmt (app-helm-tf)
      - name: Terraform fmt (app-helm-tf)
        working-directory: app-helm-tf
        run: |
          terraform fmt -check

  # ============================
  # 2. Сборка и push Docker-образов
  # ============================
  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Логин в Azure (через сервис-принципал)
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Логин в ACR
      - name: ACR login
        run: az acr login --name $ACR_NAME

      # Устанавливаем тег образа и сохраняем в outputs job'а
      - name: Set image tag
        id: set-tag
        run: |
          IMAGE_TAG=${GITHUB_RUN_NUMBER}
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      # Сборка и push Docker-образов web и api
      - name: Build & push images
        run: |
          echo "Using image tag: ${IMAGE_TAG}"

          docker build -t $WEB_IMAGE:${IMAGE_TAG} ./n-web
          docker build -t $API_IMAGE:${IMAGE_TAG} ./n-api

          docker push $WEB_IMAGE:${IMAGE_TAG}
          docker push $API_IMAGE:${IMAGE_TAG}

  # ============================
  # 3. Обновление GitOps values + git push
  # ============================
  update-gitops:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write   # нужно для git commit + push

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # yq для правки values.yaml
      - name: Install yq
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
            -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Update GitOps values
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          echo "Using image tag from build-and-push job: ${IMAGE_TAG}"

          # Обновляем теги образов в GitOps values
          yq -i ".image.tag = \"${IMAGE_TAG}\"" gitops/values/web-values.yaml
          yq -i ".image.tag = \"${IMAGE_TAG}\"" gitops/values/api-values.yaml

          git config user.email "github-actions@local"
          git config user.name "github-actions"

          git status
          git commit -am "Update images to tag ${IMAGE_TAG}" || echo "No changes"
          git push